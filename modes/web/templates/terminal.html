<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Terminal - {{name}}</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css">
    <style>
        :root {
            --bg: #f5f5f0;
            --text: #1a1a1a;
            --border: #333;
            --muted: #666;
            --accent: #4a90d9;
            /* Terminal colors for light themes */
            --term-bg: #1a1a1a;
            --term-fg: #e5e5e5;
            --term-cursor: #52d9a6;
        }
        /* Pastel Color Themes */
        [data-theme="cream"] {
            --bg: #f5f5f0;
            --text: #1a1a1a;
            --border: #333;
            --muted: #666;
            --accent: #4a90d9;
            --term-bg: #1a1a1a;
            --term-fg: #e5e5e5;
            --term-cursor: #52d9a6;
        }
        [data-theme="pink"] {
            --bg: #ffe4e9;
            --text: #4a1a28;
            --border: #d4758f;
            --muted: #8f5066;
            --accent: #ff6b9d;
            --term-bg: #2a1a1e;
            --term-fg: #ffe4e9;
            --term-cursor: #ff6b9d;
        }
        [data-theme="mint"] {
            --bg: #e0f5f0;
            --text: #1a3a33;
            --border: #6eb5a3;
            --muted: #4d8073;
            --accent: #52d9a6;
            --term-bg: #0d1f1a;
            --term-fg: #e0f5f0;
            --term-cursor: #52d9a6;
        }
        [data-theme="lavender"] {
            --bg: #f0e9ff;
            --text: #2a1a4a;
            --border: #9d85d4;
            --muted: #6b5a8f;
            --accent: #a78bfa;
            --term-bg: #1a1528;
            --term-fg: #f0e9ff;
            --term-cursor: #a78bfa;
        }
        [data-theme="peach"] {
            --bg: #ffe9dc;
            --text: #4a2a1a;
            --border: #d49675;
            --muted: #8f6650;
            --accent: #ffab7a;
            --term-bg: #1f1510;
            --term-fg: #ffe9dc;
            --term-cursor: #ffab7a;
        }
        [data-theme="sky"] {
            --bg: #e0f0ff;
            --text: #1a2e4a;
            --border: #6ba3d4;
            --muted: #4d708f;
            --accent: #5eb3ff;
            --term-bg: #0d1520;
            --term-fg: #e0f0ff;
            --term-cursor: #5eb3ff;
        }
        [data-theme="butter"] {
            --bg: #fff9e0;
            --text: #4a3f1a;
            --border: #d4c175;
            --muted: #8f8350;
            --accent: #ffd952;
            --term-bg: #1a1810;
            --term-fg: #fff9e0;
            --term-cursor: #ffd952;
        }
        [data-theme="rose"] {
            --bg: #fff0f3;
            --text: #4a1a2a;
            --border: #d47590;
            --muted: #8f5068;
            --accent: #ff9eb8;
            --term-bg: #1f1518;
            --term-fg: #fff0f3;
            --term-cursor: #ff9eb8;
        }
        [data-theme="sage"] {
            --bg: #eff5e9;
            --text: #2a331a;
            --border: #8fb575;
            --muted: #607a4d;
            --accent: #9bc978;
            --term-bg: #151a10;
            --term-fg: #eff5e9;
            --term-cursor: #9bc978;
        }
        [data-theme="periwinkle"] {
            --bg: #e9f0ff;
            --text: #1a2a4a;
            --border: #758fd4;
            --muted: #50638f;
            --accent: #8ba3ff;
            --term-bg: #10151f;
            --term-fg: #e9f0ff;
            --term-cursor: #8ba3ff;
        }
        /* Dark Mode Themes */
        [data-theme="dark"] {
            --bg: #1a1a1a;
            --text: #e5e5e5;
            --border: #444;
            --muted: #888;
            --accent: #6ab0f3;
            --term-bg: #0d0d0d;
            --term-fg: #e5e5e5;
            --term-cursor: #6ab0f3;
        }
        [data-theme="midnight"] {
            --bg: #0d1117;
            --text: #c9d1d9;
            --border: #30363d;
            --muted: #8b949e;
            --accent: #58a6ff;
            --term-bg: #010409;
            --term-fg: #c9d1d9;
            --term-cursor: #58a6ff;
        }
        [data-theme="charcoal"] {
            --bg: #2b2b2b;
            --text: #e8e6e3;
            --border: #555;
            --muted: #999;
            --accent: #ffa657;
            --term-bg: #1a1a1a;
            --term-fg: #e8e6e3;
            --term-cursor: #ffa657;
        }
        [data-theme="ocean"] {
            --bg: #e0f2f7;
            --text: #0d3b47;
            --border: #4a9fb0;
            --muted: #2d6d7a;
            --accent: #00bcd4;
            --term-bg: #051015;
            --term-fg: #e0f2f7;
            --term-cursor: #00bcd4;
        }
        [data-theme="sunset"] {
            --bg: #ffe8d9;
            --text: #4a2818;
            --border: #d47942;
            --muted: #8f5a35;
            --accent: #ff6f3c;
            --term-bg: #1a100a;
            --term-fg: #ffe8d9;
            --term-cursor: #ff6f3c;
        }
        [data-theme="forest"] {
            --bg: #e8f5e9;
            --text: #1b5e20;
            --border: #66bb6a;
            --muted: #388e3c;
            --accent: #4caf50;
            --term-bg: #0a150a;
            --term-fg: #e8f5e9;
            --term-cursor: #4caf50;
        }
        [data-theme="noir"] {
            --bg: #f8f9fa;
            --text: #000;
            --border: #000;
            --muted: #495057;
            --accent: #000;
            --term-bg: #000;
            --term-fg: #f8f9fa;
            --term-cursor: #f8f9fa;
        }
        [data-theme="retro"] {
            --bg: #0d1b0d;
            --text: #33ff33;
            --border: #33ff33;
            --muted: #1a9919;
            --accent: #66ff66;
            --term-bg: #0a0f0a;
            --term-fg: #33ff33;
            --term-cursor: #66ff66;
        }
        html { transition: background-color 0.5s ease, color 0.5s ease; }
        * { transition: border-color 0.3s ease, background-color 0.3s ease; }
        @media (prefers-color-scheme: dark) {
            :root:not([data-theme]) {
                --bg: #1a1a1a;
                --text: #e5e5e0;
                --border: #555;
                --muted: #999;
                --accent: #6ab0f3;
                --term-bg: #0d0d0d;
                --term-fg: #e5e5e0;
                --term-cursor: #6ab0f3;
            }
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body {
            height: 100%;
            overflow: hidden;
        }
        body {
            font-family: 'Courier New', monospace;
            background: var(--bg);
            color: var(--text);
            display: flex;
            flex-direction: column;
        }
        header {
            padding: 0.75rem 1rem;
            border-bottom: 2px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg);
            flex-shrink: 0;
        }
        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        header h1 {
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 0;
        }
        .conn-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            color: var(--muted);
        }
        .conn-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #52d9a6;
            transition: background 0.3s;
            flex-shrink: 0;
        }
        .conn-dot.connecting {
            background: #ffd952;
            animation: blink-dot 1s infinite;
        }
        .conn-dot.disconnected {
            background: #ff6b9d;
            animation: blink-dot 1s infinite;
        }
        @keyframes blink-dot {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        .nav {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        .nav a {
            color: var(--text);
            text-decoration: none;
            padding: 0.5rem 0.75rem;
            border: 2px solid var(--border);
            border-radius: 4px;
            font-size: 0.8rem;
            transition: all 0.2s;
        }
        .nav a:hover {
            background: var(--accent);
            color: white;
            transform: translateY(-2px);
        }
        .nav a.active {
            background: var(--text);
            color: var(--bg);
        }
        #terminal-container {
            flex: 1;
            padding: 4px;
            background: var(--term-bg);
            overflow: hidden;
        }
        #terminal {
            height: 100%;
            width: 100%;
        }
        /* xterm.js overrides for better integration */
        .xterm {
            padding: 8px;
        }
        .xterm-viewport {
            overflow-y: auto !important;
        }
        /* Toast notifications */
        .toast-container {
            position: fixed;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2000;
            display: flex;
            flex-direction: column-reverse;
            gap: 0.5rem;
            pointer-events: none;
        }
        .toast {
            padding: 0.75rem 1.25rem;
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.85rem;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
            pointer-events: auto;
            text-align: center;
            border: 2px solid var(--border);
            background: var(--bg);
            color: var(--text);
        }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.success { border-color: #52d9a6; }
        .toast.error { border-color: #ff6b9d; }
        .toast.info { border-color: var(--accent); }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            header {
                padding: 0.5rem 0.75rem;
                flex-wrap: wrap;
                gap: 0.5rem;
            }
            header h1 {
                font-size: 1rem;
            }
            .header-left {
                flex: 1;
                min-width: 0;
            }
            .conn-status {
                font-size: 0.7rem;
            }
            .nav {
                width: 100%;
                justify-content: space-between;
                gap: 4px;
            }
            .nav a {
                flex: 1;
                text-align: center;
                padding: 6px 4px;
                font-size: 0.7rem;
                white-space: nowrap;
            }
            #terminal-container {
                padding: 2px;
            }
            .xterm {
                padding: 4px;
            }
        }

        @media (max-width: 480px) {
            header h1 {
                font-size: 0.9rem;
            }
            .nav a {
                padding: 4px 2px;
                font-size: 0.65rem;
            }
            .conn-status span:last-child {
                display: none;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-left">
            <h1>Terminal</h1>
            <div class="conn-status">
                <span class="conn-dot" id="conn-dot"></span>
                <span id="conn-text">Connecting...</span>
            </div>
        </div>
        <nav class="nav">
            <a href="/">Chat</a>
            <a href="/scans">Scans</a>
            <a href="/tasks">Tasks</a>
            <a href="/terminal" class="active">Terminal</a>
            <a href="/settings">Settings</a>
        </nav>
    </header>

    <div id="terminal-container">
        <div id="terminal"></div>
    </div>

    <div class="toast-container" id="toast-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-web-links@0.9.0/lib/xterm-addon-web-links.js"></script>
    <script>
        // Apply saved theme
        function getAutoTheme() {
            const hour = new Date().getHours();
            return (hour >= 20 || hour < 7) ? 'midnight' : 'cream';
        }
        const themeAuto = localStorage.getItem('inklingThemeAuto') === 'true';
        const savedTheme = themeAuto ? getAutoTheme() : (localStorage.getItem('inklingTheme') || 'cream');
        document.documentElement.setAttribute('data-theme', savedTheme);

        // Re-check auto theme every 5 minutes
        if (themeAuto) {
            setInterval(() => {
                document.documentElement.setAttribute('data-theme', getAutoTheme());
                updateTerminalTheme();
            }, 300000);
        }

        // Toast notification system
        function showToast(message, type, duration) {
            type = type || 'info';
            duration = duration || 3000;
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast ' + type;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(function() { toast.classList.add('show'); }, 10);
            setTimeout(function() {
                toast.classList.remove('show');
                setTimeout(function() { toast.remove(); }, 300);
            }, duration);
        }

        // Terminal theme colors based on CSS variables
        function getTerminalTheme() {
            const style = getComputedStyle(document.documentElement);
            return {
                background: style.getPropertyValue('--term-bg').trim() || '#1a1a1a',
                foreground: style.getPropertyValue('--term-fg').trim() || '#e5e5e5',
                cursor: style.getPropertyValue('--term-cursor').trim() || '#52d9a6',
                cursorAccent: style.getPropertyValue('--term-bg').trim() || '#1a1a1a',
                selectionBackground: style.getPropertyValue('--accent').trim() + '66' || '#4a90d966',
                black: '#000000',
                red: '#ff6b6b',
                green: '#52d9a6',
                yellow: '#ffd952',
                blue: '#5eb3ff',
                magenta: '#a78bfa',
                cyan: '#00bcd4',
                white: '#e5e5e5',
                brightBlack: '#666666',
                brightRed: '#ff8a8a',
                brightGreen: '#7ee8c4',
                brightYellow: '#ffe57a',
                brightBlue: '#8ac8ff',
                brightMagenta: '#c4a8ff',
                brightCyan: '#4dd4e8',
                brightWhite: '#ffffff'
            };
        }

        // Initialize terminal
        const term = new Terminal({
            cursorBlink: true,
            cursorStyle: 'block',
            fontSize: 14,
            fontFamily: '"Courier New", Courier, monospace',
            theme: getTerminalTheme(),
            allowProposedApi: true,
            scrollback: 5000
        });

        const fitAddon = new FitAddon.FitAddon();
        const webLinksAddon = new WebLinksAddon.WebLinksAddon();

        term.loadAddon(fitAddon);
        term.loadAddon(webLinksAddon);

        const terminalEl = document.getElementById('terminal');
        term.open(terminalEl);
        fitAddon.fit();

        // Update terminal theme when page theme changes
        function updateTerminalTheme() {
            term.options.theme = getTerminalTheme();
        }

        // WebSocket connection
        const connDot = document.getElementById('conn-dot');
        const connText = document.getElementById('conn-text');
        let ws = null;
        let reconnectAttempts = 0;
        let reconnectTimer = null;
        const maxReconnectAttempts = 10;
        const reconnectBaseDelay = 1000;

        function setConnectionStatus(status) {
            connDot.className = 'conn-dot';
            switch (status) {
                case 'connected':
                    connDot.classList.add('connected');
                    connText.textContent = 'Connected';
                    break;
                case 'connecting':
                    connDot.classList.add('connecting');
                    connText.textContent = 'Connecting...';
                    break;
                case 'disconnected':
                    connDot.classList.add('disconnected');
                    connText.textContent = 'Disconnected';
                    break;
            }
        }

        function getWebSocketUrl() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            return protocol + '//' + window.location.host + '/api/terminal/ws';
        }

        function connect() {
            if (ws && (ws.readyState === WebSocket.CONNECTING || ws.readyState === WebSocket.OPEN)) {
                return;
            }

            setConnectionStatus('connecting');

            try {
                ws = new WebSocket(getWebSocketUrl());
            } catch (e) {
                console.error('WebSocket creation failed:', e);
                scheduleReconnect();
                return;
            }

            ws.onopen = function() {
                console.log('WebSocket connected');
                setConnectionStatus('connected');
                reconnectAttempts = 0;

                // Send initial terminal size
                sendResize();

                // Clear any reconnect message
                term.write('\r\n');
            };

            ws.onmessage = function(event) {
                // Handle binary or text data
                if (event.data instanceof Blob) {
                    event.data.text().then(function(text) {
                        term.write(text);
                    });
                } else {
                    term.write(event.data);
                }
            };

            ws.onerror = function(error) {
                console.error('WebSocket error:', error);
            };

            ws.onclose = function(event) {
                console.log('WebSocket closed:', event.code, event.reason);
                setConnectionStatus('disconnected');

                if (event.code !== 1000) {
                    // Abnormal close, attempt reconnect
                    scheduleReconnect();
                }
            };
        }

        function scheduleReconnect() {
            if (reconnectTimer) {
                clearTimeout(reconnectTimer);
            }

            if (reconnectAttempts >= maxReconnectAttempts) {
                term.write('\r\n\x1b[31mConnection failed after ' + maxReconnectAttempts + ' attempts. Refresh the page to retry.\x1b[0m\r\n');
                showToast('Connection failed. Please refresh the page.', 'error', 5000);
                return;
            }

            reconnectAttempts++;
            const delay = Math.min(reconnectBaseDelay * Math.pow(2, reconnectAttempts - 1), 30000);

            term.write('\r\n\x1b[33mConnection lost. Reconnecting in ' + Math.round(delay / 1000) + 's... (attempt ' + reconnectAttempts + '/' + maxReconnectAttempts + ')\x1b[0m\r\n');

            reconnectTimer = setTimeout(function() {
                connect();
            }, delay);
        }

        function sendResize() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                const msg = JSON.stringify({
                    type: 'resize',
                    cols: term.cols,
                    rows: term.rows
                });
                ws.send(msg);
            }
        }

        // Handle keyboard input
        term.onData(function(data) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                const msg = JSON.stringify({
                    type: 'input',
                    data: data
                });
                ws.send(msg);
            }
        });

        // Handle terminal resize
        term.onResize(function(size) {
            sendResize();
        });

        // Window resize handler
        let resizeTimeout;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(function() {
                fitAddon.fit();
            }, 100);
        });

        // Initial connection
        connect();

        // Periodic connection check
        setInterval(function() {
            if (!ws || ws.readyState === WebSocket.CLOSED) {
                if (!reconnectTimer) {
                    scheduleReconnect();
                }
            }
        }, 5000);

        // Handle page visibility changes
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'visible') {
                if (!ws || ws.readyState !== WebSocket.OPEN) {
                    reconnectAttempts = 0;
                    connect();
                }
                fitAddon.fit();
            }
        });

        // Focus terminal on click
        document.getElementById('terminal-container').addEventListener('click', function() {
            term.focus();
        });

        // Initial focus
        setTimeout(function() {
            term.focus();
        }, 100);
    </script>
</body>
</html>
